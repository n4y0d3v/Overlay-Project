<!DOCTYPE html>
<html>
<head>
  <title>Overlay MVP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f4f4f4;
      margin: 0;
      padding: 0;
      color: #333;
      transition: background 0.3s, color 0.3s;
      height: 100vh;
      overflow: hidden;
    }
    .container {
      background: #fff;
      width: 100vw;
      height: 100vh;
      box-sizing: border-box;
      position: relative;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transition: background 0.3s;
    }
    .title-bar {
      background: #fff;
      height: 40px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 12px;
      border-bottom: 1px solid #e0e0e0;
      flex-shrink: 0;
      transition: background 0.3s, border-bottom-color 0.3s;
    }
    .title-bar-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .title-bar-center {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      align-items: center;
    }
    .title-bar h1 {
      font-size: 16px;
      font-weight: 600;
      margin: 0;
      color: #1a1a1a;
      transition: color 0.3s;
    }
    .title-bar-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    #darkModeToggle, #copyOverlayUrl {
      background: none;
      border: 1px solid #d0d0d0;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      color: #666;
      display: flex;
      align-items: center;
      gap: 4px;
      transition: background 0.2s, color 0.3s, border-color 0.3s;
    }
    #darkModeToggle:hover, #copyOverlayUrl:hover {
      background: #f0f0f0;
    }
    .content {
      display: flex;
      flex-wrap: nowrap;
      gap: 0;
      flex: 1;
      overflow: hidden;
    }
    h2 { 
      font-size: 16px;
      font-weight: 500;
      margin: 16px 0 8px;
      color: #444;
      grid-column: 1 / -1;
      transition: color 0.3s;
    }
    .overlay-section {
      border-bottom: 1px solid #e0e0e0;
      padding-bottom: 8px;
      margin-bottom: 8px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .control-group-container {
      background: #f8f9fa;
      border-radius: 6px;
      padding: 8px;
      margin-bottom: 8px;
      border: 1px solid #e9ecef;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: flex-start;
    }
    .control-group-container h3 {
      font-size: 12px;
      font-weight: 600;
      color: #495057;
      margin: 0 0 8px 0;
      padding-bottom: 4px;
      border-bottom: 1px solid #e9ecef;
      width: 100%;
    }
    .control-group {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      min-width: 80px;
      margin: 0;
      flex: 1;
    }
    label { 
      font-size: 10px;
      font-weight: 500;
      margin-bottom: 1px;
      color: #666;
      transition: color 0.3s;
    }
    input[type="text"], input[type="number"], select { 
      width: 100%;
      max-width: 80px;
      padding: 2px 4px;
      font-size: 11px;
      border: 1px solid #d0d0d0;
      border-radius: 4px;
      transition: border-color 0.2s, background 0.3s, color 0.3s;
    }
    input[type="text"]:focus, input[type="number"]:focus, select:focus {
      border-color: #007bff;
      outline: none;
    }
    input[type="color"] { 
      width: 32px;
      height: 24px;
      padding: 0;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    input[type="checkbox"] { 
      margin-top: 4px;
      accent-color: #007bff;
    }
    input[type="file"] { 
      font-size: 12px;
      padding: 4px 0;
    }
    button {
      background: #007bff;
      color: #fff;
      border: none;
      padding: 2px 6px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 11px;
      font-weight: 500;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    button i {
      font-size: 11px;
    }
    button:hover { 
      background: #0056b3;
    }
    #preview {
      position: relative;
      width: 40%;
      background: #e8ecef;
      overflow: hidden;
      border: 2px dashed #007bff;
      border-radius: 6px;
      flex: 1 1 40%;
      min-width: 200px;
      height: calc(100vh - 40px);
      display: flex;
      justify-content: center;
      align-items: center;
      transition: border-color 0.3s, box-shadow 0.3s;
    }
    #preview:after {
      content: "Output Preview";
      position: absolute;
      top: 5px;
      left: 5px;
      font-size: 12px;
      color: #007bff;
      opacity: 0.7;
    }
    #outputCanvas {
      width: 100%;
      aspect-ratio: 16 / 9;
      max-width: 100%;
      max-height: 100%;
      background: #000;
      position: relative;
      border: 2px solid #333;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      overflow: hidden;
    }
    .overlay {
      position: absolute;
      transition: none;
      cursor: move;
      -webkit-user-select: none;
      user-select: none;
      z-index: 1;
    }
    .overlay.dragging {
      opacity: 0.8;
      z-index: 1000;
    }
    .live-indicator {
      position: absolute;
      top: 10px;
      left: 10px;
      background: #ff0000;
      color: #fff;
      padding: 5px 10px;
      font-size: 14px;
      font-weight: bold;
      border-radius: 4px;
    }
    #controlsContainer {
      overflow-y: auto;
      padding: 8px;
      width: 60%;
      min-width: 200px;
      background: #f8f9fa;
      border-right: 1px solid #e9ecef;
      box-sizing: border-box;
      scrollbar-width: thin;
      scrollbar-color: #adb5bd #f8f9fa;
      transition: all 0.3s ease;
      height: calc(100vh - 40px);
      position: relative;
    }
    #controlsContainer::-webkit-scrollbar {
      width: 6px;
    }
    #controlsContainer::-webkit-scrollbar-thumb {
      background: #adb5bd;
      border-radius: 3px;
      transition: background 0.3s;
    }
    #controlsContainer::-webkit-scrollbar-track {
      background: #f8f9fa;
      transition: background 0.3s;
    }
    #resizeHandle {
      position: relative;
      width: 8px;
      background: #dee2e6;
      cursor: ew-resize;
      border-radius: 4px;
      z-index: 10;
      transition: all 0.2s ease;
    }
    #resizeHandle:hover {
      background: #adb5bd;
    }

    /* Switch Styles */
    .switch {
      position: relative;
      display: inline-block;
      width: 32px;
      height: 18px;
    }
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #dee2e6;
      transition: .3s;
      border-radius: 20px;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 14px;
      width: 14px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      transition: .3s;
      border-radius: 50%;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    input:checked + .slider {
      background-color: #40c057;
      box-shadow: inset 0 2px 4px rgba(64, 192, 87, 0.2);
    }
    input:checked + .slider:before {
      transform: translateX(14px);
      box-shadow: 0 2px 4px rgba(64, 192, 87, 0.3);
    }

    /* Parallelogram Background for Reference */
    .parallelogram-bg {
      position: relative;
      background: transparent;
      padding: 8px 12px;
      color: #ffffff;
      z-index: 1;
      border: none;
    }
    .parallelogram-bg::before {
      content: '';
      position: absolute;
      top: 0;
      left: -8px;
      right: -8px;
      bottom: 0;
      background: #40c057;
      transform: skew(-15deg);
      z-index: -1;
      border-radius: 4px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(64, 192, 87, 0.2);
    }

    /* Rectangle Background for Content */
    .rectangle-bg {
      position: relative;
      background: transparent;
      padding: 8px 12px;
      color: #ffffff;
      z-index: 1;
      border: none;
    }
    .rectangle-bg::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #228be6;
      z-index: -1;
      border-radius: 6px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(34, 139, 230, 0.2);
    }

    /* Override default input styles for these classes */
    input.parallelogram-bg, input.rectangle-bg {
      border: 1px solid #d0d0d0;
      transition: border-color 0.2s, color 0.3s;
    }

    /* Focus States */
    input.parallelogram-bg:focus, input.rectangle-bg:focus {
      border-color: #fff;
      outline: none;
    }

    /* Dark Mode via Class */
    body.dark-mode {
      background: #1a1a1a;
      color: #ddd;
    }
    .dark-mode .container, .dark-mode .title-bar {
      background: #252525;
    }
    .dark-mode .title-bar {
      border-bottom-color: #444;
    }
    .dark-mode .title-bar h1 {
      color: #eee;
    }
    .dark-mode #darkModeToggle, .dark-mode #copyOverlayUrl {
      color: #aaa;
      border-color: #444;
    }
    .dark-mode #darkModeToggle:hover, .dark-mode #copyOverlayUrl:hover {
      background: #333;
    }
    .dark-mode h2 {
      color: #bbb;
    }
    .dark-mode label {
      color: #aaa;
    }
    .dark-mode input[type="text"], .dark-mode input[type="number"], .dark-mode select {
      background: #333;
      border-color: #444;
      color: #ddd;
    }
    .dark-mode input[type="text"]:focus, .dark-mode input[type="number"]:focus, .dark-mode select:focus {
      border-color: #1e90ff;
    }
    .dark-mode .parallelogram-bg::before {
      background: #1e7e34;
    }
    .dark-mode .rectangle-bg::before {
      background: #0056b3;
    }
    .dark-mode input.parallelogram-bg, .dark-mode input.rectangle-bg {
      border-color: #444;
      color: #ddd;
    }
    .dark-mode button {
      background: #1e90ff;
    }
    .dark-mode button:hover {
      background: #1c86ee;
    }
    .dark-mode #preview {
      background: #2c2c2c;
      border-color: #1e90ff;
    }
    .dark-mode #preview:after {
      color: #1e90ff;
    }
    .dark-mode #controlsContainer {
      background: #2a2a2a;
      border-right-color: #444;
      scrollbar-color: #666 #2a2a2a;
    }
    .dark-mode #controlsContainer::-webkit-scrollbar-thumb {
      background: #666;
    }
    .dark-mode #controlsContainer::-webkit-scrollbar-track {
      background: #2a2a2a;
    }
    .dark-mode #resizeHandle {
      background: #555;
    }
    .dark-mode #resizeHandle:hover {
      background: #777;
    }
    .dark-mode .overlay-section {
      border-bottom-color: #444;
    }

    /* Bible Lower-Third Specific Styles */
    .bible-lower-third {
      display: flex;
      flex-direction: column;
      gap: 0;
      width: 90%;
      opacity: 0;
      animation: fadeIn 0.5s ease-in forwards;
      position: relative;
      margin: 0 auto;
    }

    .bible-reference {
      position: relative;
      width: 15%;
      background: #28a745;
      color: #ffffff;
      font-weight: 500;
      padding: 8px 20px;
      clip-path: polygon(5% 0%, 100% 0%, 95% 100%, 0% 100%);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      opacity: 0.9;
      z-index: 2;
      border: none;
      margin-bottom: -8px;
    }

    .bible-text {
      position: relative;
      width: 75%;
      background: #007bff;
      color: #ffffff;
      font-weight: 400;
      padding: 12px 20px;
      border-radius: 0 0 8px 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      opacity: 0.9;
      z-index: 1;
      word-wrap: break-word;
      white-space: pre-wrap;
      border: none;
      min-height: fit-content;
      margin-left: 5%;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Tooltip Styles */
    .tippy-box {
      background: #ffffff;
      color: #212529;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      font-size: 13px;
      padding: 8px 12px;
      border: 1px solid #e9ecef;
    }

    .dark-mode .tippy-box {
      background: #252525;
      color: #e9ecef;
      border-color: #2d2d2d;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    /* Additional Styles */
    .large-text {
      min-height: 40px;
      resize: vertical;
      font-family: inherit;
      line-height: 1.4;
      font-size: 12px;
      width: 100%;
    }

    textarea.large-text {
      width: 100%;
      max-width: 200px;
    }

    .dark-mode .control-group-container {
      background: #2d2d2d;
      border-color: #3d3d3d;
    }

    .dark-mode .control-group-container h3 {
      color: #e9ecef;
      border-bottom-color: #3d3d3d;
    }

    .header-group {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .sub-header-group {
      display: flex;
      align-items: center;
      gap: 8px;
      width: 100%;
      margin-bottom: 8px;
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 400px;
      max-height: 80vh;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      padding: 16px;
      overflow-y: auto;
    }

    .modal-backdrop {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.3);
      z-index: 999;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .modal-header h3 {
      margin: 0;
      font-size: 14px;
      font-weight: 600;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 16px;
      cursor: pointer;
      color: #666;
    }

    .modal-close:hover {
      color: #333;
    }

    .segment-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 12px;
    }

    .segment-item {
      background: #f8f9fa;
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #e9ecef;
    }

    .segment-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .segment-controls {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }

    .modal-footer {
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }

    .dark-mode .modal {
      background: #252525;
      color: #ddd;
    }

    .dark-mode .segment-item {
      background: #2d2d2d;
      border-color: #3d3d3d;
    }

    .dark-mode .modal-close {
      color: #aaa;
    }

    .dark-mode .modal-close:hover {
      color: #fff;
    }

    /* Disabled Textarea Style */
    textarea:disabled {
      background: #e9ecef;
      color: #666;
      cursor: not-allowed;
    }

    .dark-mode textarea:disabled {
      background: #3a3a3a;
      color: #999;
    }

    /* New Style for Lyrics Title Dropdown */
    #lyricsTitle {
      max-width: 200px;
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <script src="https://unpkg.com/tippy.js@6/dist/tippy-bundle.umd.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/themes/light.css" />
</head>
<body>
  <div class="container">
    <div class="title-bar">
      <div class="title-bar-left">
        <h2>Create Your Overlay</h2>
      </div>
      <div class="title-bar-center">
        <label class="switch">
          <input type="checkbox" id="mainToggleOverlays" onchange="toggleAllOverlays()">
          <span class="slider"></span>
        </label>
      </div>
      <div class="title-bar-actions">
        <button id="copyOverlayUrl" title="Copy Overlay URL" onclick="copyOverlayUrl()">
          <i class="fas fa-copy"></i> Copy URL
        </button>
        <button id="darkModeToggle" onclick="toggleDarkMode()">
          <i class="fas fa-adjust"></i> Toggle Dark Mode
        </button>
      </div>
    </div>
    <div class="content">
      <div id="controlsContainer">
        <!-- Bible Lower-Third -->
        <div class="overlay-section">
          <div class="header-group">
            <h2 style="margin: 0;">Bible Lower-Third</h2>
            <label class="switch" style="margin: 0;">
              <input type="checkbox" id="toggleBible" onchange="toggleOverlay('bible')">
              <span class="slider"></span>
            </label>
            <button onclick="resetOverlay('bible')" style="margin: 0;">
              <i class="fas fa-undo"></i> Reset
            </button>
          </div>
          
          <div class="control-group-container">
            <h3>Verse Reference</h3>
            <div class="control-group" style="flex: 2;" data-tippy-content="Enter a Bible verse reference (e.g., John 3:16)">
              <label for="bibleReference">Reference</label>
              <input type="text" id="bibleReference" placeholder="e.g., John 3:16" value="John 3:16" maxlength="50" class="parallelogram-bg">
              <button onclick="fetchBibleVerse()" style="margin-top: 8px;">
                <i class="fas fa-download"></i> Fetch Verse
              </button>
            </div>
            <div class="control-group" data-tippy-content="Set reference font size in pixels (10-50)">
              <label for="bibleRefFontSize">Font Size</label>
              <input type="number" id="bibleRefFontSize" min="10" max="50" value="12">
            </div>
            <div class="control-group" data-tippy-content="Select reference text color">
              <label for="bibleRefFontColor">Font Color</label>
              <input type="color" id="bibleRefFontColor" value="#ffffff">
            </div>
            <div class="control-group" data-tippy-content="Select reference background color">
              <label for="bibleRefBgColor">Bg Color</label>
              <input type="color" id="bibleRefBgColor" value="#28a745">
            </div>
            <div class="control-group" data-tippy-content="Make reference background transparent">
              <label for="bibleRefBgTransparent">Transparent</label>
              <input type="checkbox" id="bibleRefBgTransparent">
            </div>
          </div>

          <div class="control-group-container">
            <h3>Verse Content</h3>
            <div class="control-group" data-tippy-content="Enter verse content manually or fetch from API" style="flex: 2;">
              <label for="bibleContent">Content</label>
              <textarea id="bibleContent" placeholder="Enter verse or fetch..." value="For God so loved the world..." maxlength="500" class="rectangle-bg large-text"></textarea>
            </div>
            <div class="control-group" data-tippy-content="Set content font size in pixels (10-50)" style="flex: 1;">
              <label for="bibleTextFontSize">Font Size</label>
              <input type="number" id="bibleTextFontSize" min="10" max="50" value="12">
            </div>
            <div class="control-group" data-tippy-content="Select content text color" style="flex: 1;">
              <label for="bibleTextFontColor">Font Color</label>
              <input type="color" id="bibleTextFontColor" value="#ffffff">
            </div>
            <div class="control-group" data-tippy-content="Select content background color" style="flex: 1;">
              <label for="bibleTextBgColor">Bg Color</label>
              <input type="color" id="bibleTextBgColor" value="#007bff">
            </div>
            <div class="control-group" data-tippy-content="Make content background transparent" style="flex: 1;">
              <label for="bibleTextBgTransparent">Transparent</label>
              <input type="checkbox" id="bibleTextBgTransparent">
            </div>
          </div>
        </div>

        <!-- Lyrics Lower-Third -->
        <div class="overlay-section">
          <div class="header-group">
            <h2 style="margin: 0;">Lyrics Lower-Third</h2>
            <label class="switch" style="margin: 0;">
              <input type="checkbox" id="toggleLyrics" onchange="toggleOverlay('lyrics')">
              <span class="slider"></span>
            </label>
            <button onclick="resetOverlay('lyrics')" style="margin: 0;">
              <i class="fas fa-undo"></i> Reset
            </button>
          </div>
          
          <div class="control-group-container">
            <h3>Lyrics Title</h3>
            <div class="control-group" data-tippy-content="Select song title">
              <label for="lyricsTitle">Title</label>
              <select id="lyricsTitle" onchange="selectSong(this.value)" class="parallelogram-bg">
                <option value="">Select a Song</option>
              </select>
            </div>
            <div class="control-group" data-tippy-content="Set title font size in pixels (10-50)">
              <label for="lyricsTitleFontSize">Font Size</label>
              <input type="number" id="lyricsTitleFontSize" min="10" max="50" value="12">
            </div>
            <div class="control-group" data-tippy-content="Select title text color">
              <label for="lyricsTitleFontColor">Font Color</label>
              <input type="color" id="lyricsTitleFontColor" value="#ffffff">
            </div>
            <div class="control-group" data-tippy-content="Select title background color">
              <label for="lyricsTitleBgColor">Bg Color</label>
              <input type="color" id="lyricsTitleBgColor" value="#28a745">
            </div>
            <div class="control-group" data-tippy-content="Make title background transparent">
              <label for="lyricsTitleBgTransparent">Transparent</label>
              <input type="checkbox" id="lyricsTitleBgTransparent">
            </div>
          </div>

          <div class="control-group-container">
            <h3>Lyrics Content</h3>
            <div class="control-group" data-tippy-content="View current segment; manage segments in modal" style="flex: 2;">
              <label for="lyricsText">Content</label>
              <textarea id="lyricsText" placeholder="Select a song and manage segments..." disabled class="rectangle-bg large-text"></textarea>
              <button onclick="openLyricsModal()" style="margin-top: 8px;">
                <i class="fas fa-list"></i> Manage Songs & Segments
              </button>
            </div>
            <div class="control-group" data-tippy-content="Set content font size in pixels (10-50)" style="flex: 1;">
              <label for="lyricsTextFontSize">Font Size</label>
              <input type="number" id="lyricsTextFontSize" min="10" max="50" value="12">
            </div>
            <div class="control-group" data-tippy-content="Select content text color" style="flex: 1;">
              <label for="lyricsTextFontColor">Font Color</label>
              <input type="color" id="lyricsTextFontColor" value="#ffffff">
            </div>
            <div class="control-group" data-tippy-content="Select content background color" style="flex: 1;">
              <label for="lyricsTextBgColor">Bg Color</label>
              <input type="color" id="lyricsTextBgColor" value="#007bff">
            </div>
            <div class="control-group" data-tippy-content="Make content background transparent" style="flex: 1;">
              <label for="lyricsTextBgTransparent">Transparent</label>
              <input type="checkbox" id="lyricsTextBgTransparent">
            </div>
          </div>
        </div>

        <!-- Presenter Lower-Third -->
        <div class="overlay-section">
          <div class="header-group">
            <h2 style="margin: 0;">Presenter Lower-Third</h2>
            <label class="switch" style="margin: 0;">
              <input type="checkbox" id="togglePresenter" onchange="toggleOverlay('presenter')">
              <span class="slider"></span>
            </label>
            <button onclick="resetOverlay('presenter')" style="margin: 0;">
              <i class="fas fa-undo"></i> Reset
            </button>
          </div>
          
          <div class="control-group-container">
            <h3>Presenter Title</h3>
            <div class="control-group" data-tippy-content="Enter presenter title">
              <label for="presenterTitle">Title</label>
              <input type="text" id="presenterTitle" placeholder="e.g., Pastor" value="Pastor" maxlength="50" class="parallelogram-bg">
            </div>
            <div class="control-group" data-tippy-content="Set title font size in pixels (10-50)">
              <label for="presenterTitleFontSize">Font Size</label>
              <input type="number" id="presenterTitleFontSize" min="10" max="50" value="12">
            </div>
            <div class="control-group" data-tippy-content="Select title text color">
              <label for="presenterTitleFontColor">Font Color</label>
              <input type="color" id="presenterTitleFontColor" value="#ffffff">
            </div>
            <div class="control-group" data-tippy-content="Select title background color">
              <label for="presenterTitleBgColor">Bg Color</label>
              <input type="color" id="presenterTitleBgColor" value="#28a745">
            </div>
            <div class="control-group" data-tippy-content="Make title background transparent">
              <label for="presenterTitleBgTransparent">Transparent</label>
              <input type="checkbox" id="presenterTitleBgTransparent">
            </div>
          </div>

          <div class="control-group-container">
            <h3>Presenter Name</h3>
            <div class="control-group" data-tippy-content="Enter presenter name">
              <label for="presenterText">Name</label>
              <input type="text" id="presenterText" placeholder="e.g., John Doe" value="John Doe" maxlength="50" class="rectangle-bg">
            </div>
            <div class="control-group" data-tippy-content="Set name font size in pixels (10-50)">
              <label for="presenterTextFontSize">Font Size</label>
              <input type="number" id="presenterTextFontSize" min="10" max="50" value="12">
            </div>
            <div class="control-group" data-tippy-content="Select name text color">
              <label for="presenterTextFontColor">Font Color</label>
              <input type="color" id="presenterTextFontColor" value="#ffffff">
            </div>
            <div class="control-group" data-tippy-content="Select name background color">
              <label for="presenterTextBgColor">Bg Color</label>
              <input type="color" id="presenterTextBgColor" value="#007bff">
            </div>
            <div class="control-group" data-tippy-content="Make name background transparent">
              <label for="presenterTextBgTransparent">Transparent</label>
              <input type="checkbox" id="presenterTextBgTransparent">
            </div>
          </div>
        </div>

        <!-- Ticker -->
        <div class="overlay-section">
          <div class="header-group">
            <h2 style="margin: 0;">Ticker</h2>
            <label class="switch" style="margin: 0;">
              <input type="checkbox" id="toggleTicker" onchange="toggleOverlay('ticker')">
              <span class="slider"></span>
            </label>
            <div class="control-group" data-tippy-content="Set content scroll speed in pixels per second (10-100)" style="flex: none; min-width: auto;">
              <label for="tickerScrollSpeed">Scroll Speed (px/s)</label>
              <input type="number" id="tickerScrollSpeed" min="10" max="100" value="50">
            </div>
            <button onclick="resetOverlay('ticker')" style="margin: 0;">
              <i class="fas fa-undo"></i> Reset
            </button>
          </div>
          
          <div class="control-group-container">
            <div class="sub-header-group">
              <h3 style="margin: 0;">Ticker Title</h3>
              <div class="control-group" data-tippy-content="Toggle title blink animation" style="flex: none; min-width: auto;">
                <label for="tickerTitleBlink">Blink Title</label>
                <input type="checkbox" id="tickerTitleBlink">
              </div>
            </div>
            <div class="control-group" data-tippy-content="Enter ticker title">
              <label for="tickerTitle">Title</label>
              <input type="text" id="tickerTitle" placeholder="e.g., News" value="News" maxlength="50" class="parallelogram-bg">
            </div>
            <div class="control-group" data-tippy-content="Set title font size in pixels (10-50)">
              <label for="tickerTitleFontSize">Font Size</label>
              <input type="number" id="tickerTitleFontSize" min="10" max="50" value="14">
            </div>
            <div class="control-group" data-tippy-content="Select title text color">
              <label for="tickerTitleFontColor">Font Color</label>
              <input type="color" id="tickerTitleFontColor" value="#000000">
            </div>
            <div class="control-group" data-tippy-content="Select title background color">
              <label for="tickerTitleBgColor">Bg Color</label>
              <input type="color" id="tickerTitleBgColor" value="#ffffff">
            </div>
            <div class="control-group" data-tippy-content="Make title background transparent">
              <label for="tickerTitleBgTransparent">Transparent</label>
              <input type="checkbox" id="tickerTitleBgTransparent">
            </div>
          </div>

          <div class="control-group-container">
            <h3>Ticker Content</h3>
            <div class="control-group" data-tippy-content="Enter ticker content" style="flex: 2;">
              <label for="tickerText">Content</label>
              <textarea id="tickerText" placeholder="e.g., Breaking News" value="Breaking News" maxlength="950" class="rectangle-bg large-text"></textarea>
            </div>
            <div class="control-group" data-tippy-content="Set content font size in pixels (10-50)" style="flex: 1;">
              <label for="tickerTextFontSize">Font Size</label>
              <input type="number" id="tickerTextFontSize" min="10" max="50" value="14">
            </div>
            <div class="control-group" data-tippy-content="Select content text color" style="flex: 1;">
              <label for="tickerTextFontColor">Font Color</label>
              <input type="color" id="tickerTextFontColor" value="#ffffff">
            </div>
            <div class="control-group" data-tippy-content="Select content background color" style="flex: 1;">
              <label for="tickerTextBgColor">Bg Color</label>
              <input type="color" id="tickerTextBgColor" value="#ff0000">
            </div>
            <div class="control-group" data-tippy-content="Make content background transparent" style="flex: 1;">
              <label for="tickerTextBgTransparent">Transparent</label>
              <input type="checkbox" id="tickerTextBgTransparent">
            </div>
          </div>
        </div>

        <!-- Image Upload -->
        <div class="overlay-section">
          <div class="header-group">
            <h2 style="margin: 0;">Image Upload</h2>
            <label class="switch" style="margin: 0;">
              <input type="checkbox" id="toggleImage" onchange="toggleOverlay('image')">
              <span class="slider"></span>
            </label>
            <button onclick="resetOverlay('image')" style="margin: 0;">
              <i class="fas fa-undo"></i> Reset
            </button>
          </div>
          <div class="control-group" data-tippy-content="Upload a PNG image">
            <label for="imageInput">Upload PNG</label>
            <input type="file" id="imageInput" accept=".png">
          </div>
        </div>

        <!-- Lyrics Modal -->
        <div id="lyricsModal" class="modal">
          <div class="modal-header">
            <h3>Manage Songs & Segments</h3>
            <button class="modal-close" onclick="closeLyricsModal(false)">✕</button>
          </div>
          <div class="control-group" style="margin-bottom: 12px;">
            <label for="modalSongTitle">Song Title</label>
            <input type="text" id="modalSongTitle" placeholder="Enter song title" maxlength="50">
          </div>
          <div id="segmentList" class="segment-list"></div>
          <div class="segment-controls" style="margin-bottom: 12px;">
            <button onclick="addSegment()">Add Segment</button>
            <button onclick="newSong()">New Song</button>
          </div>
          <div class="modal-footer">
            <div class="segment-controls">
              <button onclick="prevSegment()" title="Previous Segment">
                <i class="fas fa-arrow-left"></i> Prev
              </button>
              <button onclick="nextSegment()" title="Next Segment">
                <i class="fas fa-arrow-right"></i> Next
              </button>
            </div>
            <button onclick="closeLyricsModal(true)">Apply</button>
          </div>
        </div>
        <div id="modalBackdrop" class="modal-backdrop" onclick="closeLyricsModal(false)"></div>
      </div>
      <div id="resizeHandle"></div>
      <div id="preview">
        <div id="outputCanvas">
          <div class="live-indicator">LIVE</div>
        </div>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();
  let overlayId = null;
  const API_KEY = 'YOUR_API_KEY'; // Replace with your API.Bible key
  const BIBLE_ID = 'de4e12af7f28f599-01'; // KJV
  const overlayTypes = ['bible', 'lyrics', 'presenter', 'ticker', 'image'];
  const overlayStates = {
    bible: false,
    lyrics: false,
    presenter: false,
    ticker: false,
    image: false
  };
  const overlayElements = {};

  const bookMap = {
    'genesis': 'GEN', 'gen': 'GEN',
    'exodus': 'EXO', 'exo': 'EXO',
    'john': 'JHN', 'jn': 'JHN',
    'matthew': 'MAT', 'matt': 'MAT',
    'mark': 'MRK', 'mk': 'MRK',
    'luke': 'LUK', 'lk': 'LUK',
  };

  // Lyrics Song Management
  let songs = []; // Array of { title: string, segments: [{ type: string, content: string }], activeSegmentIndex: number }
  let currentSongIndex = -1;
  let tempSong = { title: '', segments: [], activeSegmentIndex: 0 };

  function openLyricsModal() {
    const modal = document.getElementById('lyricsModal');
    const backdrop = document.getElementById('modalBackdrop');
    const songTitleInput = document.getElementById('modalSongTitle');

    if (currentSongIndex >= 0 && songs[currentSongIndex]) {
      tempSong = JSON.parse(JSON.stringify(songs[currentSongIndex]));
      songTitleInput.value = tempSong.title;
    } else {
      tempSong = { title: '', segments: [{ type: 'Verse', content: '' }], activeSegmentIndex: 0 };
      songTitleInput.value = '';
    }

    renderSegments();
    modal.style.display = 'block';
    backdrop.style.display = 'block';
  }

  function closeLyricsModal(apply) {
    const modal = document.getElementById('lyricsModal');
    const backdrop = document.getElementById('modalBackdrop');
    modal.style.display = 'none';
    backdrop.style.display = 'none';

    if (apply) {
      tempSong.title = document.getElementById('modalSongTitle').value.trim();
      if (!tempSong.title) {
        alert('Please enter a song title.');
        return;
      }

      const existingSongIndex = songs.findIndex(s => s.title === tempSong.title);
      if (existingSongIndex >= 0) {
        if (confirm(`A song titled "${tempSong.title}" already exists. Overwrite it?`)) {
          songs[existingSongIndex] = tempSong;
          currentSongIndex = existingSongIndex;
        }
      } else {
        songs.push(tempSong);
        currentSongIndex = songs.length - 1;
      }

      updateSongDropdown();
      selectSong(tempSong.title);
    }
  }

  function addSegment() {
    tempSong.segments.push({ type: 'Verse', content: '' });
    renderSegments();
  }

  function newSong() {
    tempSong = { title: '', segments: [{ type: 'Verse', content: '' }], activeSegmentIndex: 0 };
    document.getElementById('modalSongTitle').value = '';
    currentSongIndex = -1; // Reset to indicate a new song
    renderSegments();
  }

  function removeSegment(index) {
    tempSong.segments.splice(index, 1);
    if (tempSong.activeSegmentIndex >= tempSong.segments.length) {
      tempSong.activeSegmentIndex = tempSong.segments.length - 1;
    }
    renderSegments();
    updateOverlay('lyrics');
  }

  function renderSegments() {
    const segmentList = document.getElementById('segmentList');
    segmentList.innerHTML = '';
    tempSong.segments.forEach((segment, index) => {
      const segmentItem = document.createElement('div');
      segmentItem.className = 'segment-item';
      segmentItem.innerHTML = `
        <div class="segment-header">
          <select onchange="updateSegmentType(${index}, this.value)">
            <option value="Verse" ${segment.type === 'Verse' ? 'selected' : ''}>Verse</option>
            <option value="Chorus" ${segment.type === 'Chorus' ? 'selected' : ''}>Chorus</option>
          </select>
          <button onclick="removeSegment(${index})"><i class="fas fa-trash"></i></button>
        </div>
        <textarea class="large-text" rows="3" maxlength="500" oninput="updateSegmentContent(${index}, this.value)">${segment.content}</textarea>
      `;
      if (index === tempSong.activeSegmentIndex) {
        segmentItem.style.background = '#e0f0ff';
      }
      segmentList.appendChild(segmentItem);
    });
  }

  function updateSegmentType(index, type) {
    tempSong.segments[index].type = type;
  }

  function updateSegmentContent(index, content) {
    tempSong.segments[index].content = content;
    if (index === tempSong.activeSegmentIndex) {
      updateOverlay('lyrics');
    }
  }

  function setActiveSegment(index) {
    if (index >= 0 && index < tempSong.segments.length) {
      tempSong.activeSegmentIndex = index;
      // Sync with the current song in songs array if it exists
      if (currentSongIndex >= 0 && songs[currentSongIndex] && songs[currentSongIndex].title === tempSong.title) {
        songs[currentSongIndex].activeSegmentIndex = index;
      }
      document.getElementById('lyricsText').value = tempSong.segments[index].content;
      updateOverlay('lyrics');
      renderSegments();
    }
  }

  function nextSegment() {
    if (tempSong.activeSegmentIndex < tempSong.segments.length - 1) {
      setActiveSegment(tempSong.activeSegmentIndex + 1);
    }
  }

  function prevSegment() {
    if (tempSong.activeSegmentIndex > 0) {
      setActiveSegment(tempSong.activeSegmentIndex - 1);
    }
  }

  function updateSongDropdown() {
    const dropdown = document.getElementById('lyricsTitle');
    dropdown.innerHTML = '<option value="">Select a Song</option>';
    songs.forEach(song => {
      const option = document.createElement('option');
      option.value = song.title;
      option.textContent = song.title;
      if (currentSongIndex >= 0 && song.title === songs[currentSongIndex].title) {
        option.selected = true;
      }
      dropdown.appendChild(option);
    });
  }

  function selectSong(title) {
    currentSongIndex = songs.findIndex(s => s.title === title);
    if (currentSongIndex >= 0) {
      const song = songs[currentSongIndex];
      document.getElementById('lyricsText').value = song.segments[song.activeSegmentIndex]?.content || '';
      // Sync tempSong with the selected song when switching
      tempSong = JSON.parse(JSON.stringify(song));
      updateOverlay('lyrics');
    } else {
      document.getElementById('lyricsText').value = '';
      tempSong = { title: '', segments: [{ type: 'Verse', content: '' }], activeSegmentIndex: 0 };
      updateOverlay('lyrics');
    }
  }

  async function fetchBibleText(input) {
    try {
      const cleanedInput = input.replace(/\s+/g, ' ').trim().toLowerCase();
      const rangeMatch = cleanedInput.match(/([a-zA-Z\s]+)\s*(\d+:\d+)(?:\s*[-–]\s*(\d+:\d+))?/);
      const singleMatch = cleanedInput.match(/([a-zA-Z\s]+)\s*(\d+:\d+)/);

      if (!singleMatch) {
        return { text: input, ref: input };
      }

      let book = singleMatch[1].trim();
      let startVerse = singleMatch[2];
      let endVerse = rangeMatch && rangeMatch[3] ? rangeMatch[3] : null;

      book = bookMap[book] || bookMap[book.replace(/\s/g, '')] || 'JHN';
      const startRef = `${book}.${startVerse}`;
      const apiRef = endVerse ? `${startRef}-${book}.${endVerse}` : startRef;

      const response = await fetch(`https://api.scripture.api.bible/v1/bibles/${BIBLE_ID}/passages/${apiRef}?content-type=text`, {
        headers: { 'api-key': API_KEY }
      });

      if (!response.ok) throw new Error(`API error: ${response.status}`);
      const data = await response.json();
      const text = data.data.content.replace(/\n/g, ' ').trim();
      const ref = data.data.reference;
      document.getElementById('bibleContent').value = text;
      return { text, ref };
    } catch (error) {
      console.error('Error fetching Bible text:', error);
      document.getElementById('bibleContent').value = `Error: Invalid reference (${input})`;
      return { text: `Error: Invalid reference (${input})`, ref: input };
    }
  }

  function fetchBibleVerse() {
    const reference = document.getElementById('bibleReference').value;
    fetchBibleText(reference).then(bibleData => {
      updateOverlay('bible');
    });
  }

  function updateOverlay(type) {
    overlayId = overlayId || Math.random().toString(36).substring(2, 7);
    const data = { id: overlayId, type };

    if (type === 'image') {
      const file = document.getElementById('imageInput').files[0];
      if (file && file.type === 'image/png') {
        const reader = new FileReader();
        reader.onload = () => {
          data.image = reader.result;
          socket.emit('customize', data);
          if (overlayStates[type]) renderOverlay(data);
        };
        reader.readAsDataURL(file);
      }
    } else {
      if (type === 'bible') {
        data.ref = document.getElementById('bibleReference').value;
        data.text = document.getElementById('bibleContent').value;
        data.refFontSize = document.getElementById('bibleRefFontSize').value + 'px';
        data.textFontSize = document.getElementById('bibleTextFontSize').value + 'px';
        data.refFontColor = document.getElementById('bibleRefFontColor').value;
        data.textFontColor = document.getElementById('bibleTextFontColor').value;
        data.refBgColor = document.getElementById('bibleRefBgTransparent').checked ? 'transparent' : document.getElementById('bibleRefBgColor').value;
        data.textBgColor = document.getElementById('bibleTextBgTransparent').checked ? 'transparent' : document.getElementById('bibleTextBgColor').value;
      } else if (type === 'lyrics') {
        const selectedSongTitle = document.getElementById('lyricsTitle').value;
        const song = songs.find(s => s.title === selectedSongTitle);
        data.title = selectedSongTitle;
        data.text = song && song.segments[song.activeSegmentIndex] ? song.segments[song.activeSegmentIndex].content : '';
        data.titleFontSize = document.getElementById('lyricsTitleFontSize').value + 'px';
        data.textFontSize = document.getElementById('lyricsTextFontSize').value + 'px';
        data.titleFontColor = document.getElementById('lyricsTitleFontColor').value;
        data.textFontColor = document.getElementById('lyricsTextFontColor').value;
        data.titleBgColor = document.getElementById('lyricsTitleBgTransparent').checked ? 'transparent' : document.getElementById('lyricsTitleBgColor').value;
        data.textBgColor = document.getElementById('lyricsTextBgTransparent').checked ? 'transparent' : document.getElementById('lyricsTextBgColor').value;
      } else if (type === 'presenter') {
        data.title = document.getElementById('presenterTitle').value;
        data.text = document.getElementById('presenterText').value;
        data.titleFontSize = document.getElementById('presenterTitleFontSize').value + 'px';
        data.textFontSize = document.getElementById('presenterTextFontSize').value + 'px';
        data.titleFontColor = document.getElementById('presenterTitleFontColor').value;
        data.textFontColor = document.getElementById('presenterTextFontColor').value;
        data.titleBgColor = document.getElementById('presenterTitleBgTransparent').checked ? 'transparent' : document.getElementById('presenterTitleBgColor').value;
        data.textBgColor = document.getElementById('presenterTextBgTransparent').checked ? 'transparent' : document.getElementById('presenterTextBgColor').value;
      } else if (type === 'ticker') {
        data.title = document.getElementById('tickerTitle').value;
        data.text = document.getElementById('tickerText').value;
        data.titleFontSize = document.getElementById('tickerTitleFontSize').value + 'px';
        data.textFontSize = document.getElementById('tickerTextFontSize').value + 'px';
        data.titleFontColor = document.getElementById('tickerTitleFontColor').value;
        data.textFontColor = document.getElementById('tickerTextFontColor').value;
        data.titleBgColor = document.getElementById('tickerTitleBgTransparent').checked ? 'transparent' : document.getElementById('tickerTitleBgColor').value;
        data.textBgColor = document.getElementById('tickerTextBgTransparent').checked ? 'transparent' : document.getElementById('tickerTextBgColor').value;
        data.titleBlink = document.getElementById('tickerTitleBlink').checked;
        data.scrollSpeed = parseInt(document.getElementById('tickerScrollSpeed').value, 10);
      }
      socket.emit('customize', data);
      if (overlayStates[type]) renderOverlay(data);
    }
  }

  function renderOverlay(data) {
    const outputCanvas = document.getElementById('outputCanvas');
    let overlay = overlayElements[data.type];
    if (!overlay) {
      overlay = document.createElement('div');
      overlay.id = `overlay-${data.type}`;
      overlay.className = 'overlay';
      overlayElements[data.type] = overlay;
      outputCanvas.appendChild(overlay);
      
      if (data.type !== 'ticker') {
        makeDraggable(overlay, data.type);
      }
    }

    if (data.type === 'bible') {
      if (!overlay.style.top && !overlay.style.left) {
        overlay.style.width = '90%';
        overlay.style.left = '50%';
        overlay.style.transform = 'translateX(-50%)';
        overlay.style.bottom = '120px';
      }
      overlay.innerHTML = `
        <div class="bible-lower-third">
          <div class="bible-reference" style="color: ${data.refFontColor}; font-size: ${data.refFontSize}; background: ${data.refBgColor}">${data.ref}</div>
          <div class="bible-text" style="color: ${data.textFontColor}; font-size: ${data.textFontSize}; background: ${data.textBgColor}">${data.text}</div>
        </div>
      `;
    } else if (data.type === 'lyrics') {
      if (!overlay.style.top && !overlay.style.left) {
        overlay.style.width = '90%';
        overlay.style.left = '50%';
        overlay.style.transform = 'translateX(-50%)';
        overlay.style.bottom = '120px';
      }
      overlay.innerHTML = `
        <div class="bible-lower-third">
          <div class="bible-reference" style="color: ${data.titleFontColor}; font-size: ${data.titleFontSize}; background: ${data.titleBgColor}">${data.title}</div>
          <div class="bible-text" style="color: ${data.textFontColor}; font-size: ${data.textFontSize}; background: ${data.textBgColor}">${data.text}</div>
        </div>
      `;
    } else if (data.type === 'presenter') {
      if (!overlay.style.top && !overlay.style.left) {
        overlay.style.width = '90%';
        overlay.style.left = '50%';
        overlay.style.transform = 'translateX(-50%)';
        overlay.style.bottom = '120px';
      }
      overlay.innerHTML = `
        <div class="bible-lower-third">
          <div class="bible-reference" style="color: ${data.titleFontColor}; font-size: ${data.titleFontSize}; background: ${data.titleBgColor}">${data.title}</div>
          <div class="bible-text" style="color: ${data.textFontColor}; font-size: ${data.textFontSize}; background: ${data.textBgColor}">${data.text}</div>
        </div>
      `;
    } else if (data.type === 'ticker') {
      overlay.style.bottom = '5px';
      overlay.style.left = '0';
      overlay.style.width = '100%';
      const fontSizePx = parseInt(data.textFontSize, 10);
      const tickerHeight = fontSizePx + 8;
      overlay.style.height = `${tickerHeight}px`;
      overlay.style.overflow = 'hidden';
      overlay.style.display = 'flex';

      const tempDiv = document.createElement('div');
      tempDiv.style.position = 'absolute';
      tempDiv.style.visibility = 'hidden';
      tempDiv.style.whiteSpace = 'nowrap';
      tempDiv.style.fontSize = data.textFontSize;
      tempDiv.textContent = data.text + ' • ';
      document.body.appendChild(tempDiv);
      const textWidth = tempDiv.offsetWidth;
      document.body.removeChild(tempDiv);

      const contentContainerWidth = outputCanvas.offsetWidth * 0.85;
      const minRepetitions = Math.ceil((contentContainerWidth * 2) / textWidth);
      const repeatedText = (data.text + ' • ').repeat(Math.max(minRepetitions, 2));

      const tempDivRepeated = document.createElement('div');
      tempDivRepeated.style.position = 'absolute';
      tempDivRepeated.style.visibility = 'hidden';
      tempDivRepeated.style.whiteSpace = 'nowrap';
      tempDivRepeated.style.fontSize = data.textFontSize;
      tempDivRepeated.textContent = repeatedText;
      document.body.appendChild(tempDivRepeated);
      const repeatedTextWidth = tempDivRepeated.offsetWidth;
      document.body.removeChild(tempDivRepeated);

      const scrollSpeedPxPerSec = data.scrollSpeed;
      const animationDuration = repeatedTextWidth / scrollSpeedPxPerSec;

      overlay.innerHTML = `
        <div style="width: 15%; height: 100%; background: ${data.titleBgColor}; font-size: ${data.titleFontSize}; padding: 2px 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
          <span style="color: ${data.titleFontColor}; ${data.titleBlink ? 'animation: blink 1s step-end infinite;' : ''}">
            ${data.title}
          </span>
        </div>
        <div style="width: 85%; height: 100%; background: ${data.textBgColor}; position: relative; overflow: hidden;">
          <div id="tickerContent-${data.id}" style="color: ${data.textFontColor}; font-size: ${data.textFontSize}; white-space: nowrap; animation: scroll ${animationDuration}s linear infinite; padding: 2px 10px; display: inline-block; position: absolute; top: 0; left: 0;">
            ${repeatedText}
          </div>
        </div>
      `;
      overlay.innerHTML += `
        <style>
          @keyframes scroll {
            0% { transform: translateX(0); }
            100% { transform: translateX(-${repeatedTextWidth}px); }
          }
          @keyframes blink {
            50% { opacity: 0; }
          }
        </style>
      `;
    } else if (data.type === 'image') {
      overlay.style.left = '20px';
      overlay.style.top = '20px';
      overlay.innerHTML = `<img src="${data.image}" style="width: 200px; height: 200px;">`;
    }
  }

  function toggleOverlay(type) {
    const toggleSwitch = document.getElementById(`toggle${type.charAt(0).toUpperCase() + type.slice(1)}`);
    overlayStates[type] = toggleSwitch.checked;
    if (overlayStates[type]) {
      updateOverlay(type);
    } else {
      const overlay = overlayElements[type];
      if (overlay) {
        overlay.remove();
        delete overlayElements[type];
      }
    }
    updateMainToggleState();
  }

  function toggleAllOverlays() {
    const allVisible = Object.values(overlayStates).every(state => state);
    overlayTypes.forEach(type => {
      overlayStates[type] = !allVisible;
      const toggleSwitch = document.getElementById(`toggle${type.charAt(0).toUpperCase() + type.slice(1)}`);
      toggleSwitch.checked = overlayStates[type];
      if (overlayStates[type]) {
        updateOverlay(type);
      } else {
        const overlay = overlayElements[type];
        if (overlay) {
          overlay.remove();
          delete overlayElements[type];
        }
      }
    });
    updateMainToggleState();
  }

  function updateMainToggleState() {
    const allVisible = Object.values(overlayStates).every(state => state);
    const mainToggleSwitch = document.getElementById('mainToggleOverlays');
    mainToggleSwitch.checked = allVisible;
  }

  function copyOverlayUrl() {
    if (!overlayId) return;
    const url = `${window.location.origin}/overlay/${overlayId}`;
    navigator.clipboard.writeText(url).then(() => {
      alert('Overlay URL copied to clipboard!');
    }).catch(err => {
      console.error('Failed to copy URL:', err);
    });
  }

  function resetOverlay(type) {
    if (type === 'bible') {
      document.getElementById('bibleReference').value = 'John 3:16';
      document.getElementById('bibleContent').value = 'For God so loved the world...';
      document.getElementById('bibleRefFontSize').value = '12';
      document.getElementById('bibleTextFontSize').value = '12';
      document.getElementById('bibleRefFontColor').value = '#ffffff';
      document.getElementById('bibleTextFontColor').value = '#ffffff';
      document.getElementById('bibleRefBgColor').value = '#28a745';
      document.getElementById('bibleTextBgColor').value = '#007bff';
      document.getElementById('bibleRefBgTransparent').checked = false;
      document.getElementById('bibleTextBgTransparent').checked = false;
    } else if (type === 'lyrics') {
      songs = [];
      currentSongIndex = -1;
      updateSongDropdown();
      document.getElementById('lyricsText').value = '';
      document.getElementById('lyricsTitleFontSize').value = '12';
      document.getElementById('lyricsTextFontSize').value = '12';
      document.getElementById('lyricsTitleFontColor').value = '#ffffff';
      document.getElementById('lyricsTextFontColor').value = '#ffffff';
      document.getElementById('lyricsTitleBgColor').value = '#28a745';
      document.getElementById('lyricsTextBgColor').value = '#007bff';
      document.getElementById('lyricsTitleBgTransparent').checked = false;
      document.getElementById('lyricsTextBgTransparent').checked = false;
    } else if (type === 'presenter') {
      document.getElementById('presenterTitle').value = 'Pastor';
      document.getElementById('presenterText').value = 'John Doe';
      document.getElementById('presenterTitleFontSize').value = '12';
      document.getElementById('presenterTextFontSize').value = '12';
      document.getElementById('presenterTitleFontColor').value = '#ffffff';
      document.getElementById('presenterTextFontColor').value = '#ffffff';
      document.getElementById('presenterTitleBgColor').value = '#28a745';
      document.getElementById('presenterTextBgColor').value = '#007bff';
      document.getElementById('presenterTitleBgTransparent').checked = false;
      document.getElementById('presenterTextBgTransparent').checked = false;
    } else if (type === 'ticker') {
      document.getElementById('tickerTitle').value = 'News';
      document.getElementById('tickerText').value = 'Breaking News';
      document.getElementById('tickerTitleFontSize').value = '14';
      document.getElementById('tickerTextFontSize').value = '14';
      document.getElementById('tickerTitleFontColor').value = '#000000';
      document.getElementById('tickerTextFontColor').value = '#ffffff';
      document.getElementById('tickerTitleBgColor').value = '#ffffff';
      document.getElementById('tickerTextBgColor').value = '#ff0000';
      document.getElementById('tickerTitleBgTransparent').checked = false;
      document.getElementById('tickerTextBgTransparent').checked = false;
      document.getElementById('tickerScrollSpeed').value = '50';
      document.getElementById('tickerTitleBlink').checked = false;
    } else if (type === 'image') {
      document.getElementById('imageInput').value = '';
    }
    if (overlayStates[type]) updateOverlay(type);
  }

  const resizeHandle = document.getElementById('resizeHandle');
  const controlsContainer = document.getElementById('controlsContainer');
  const preview = document.getElementById('preview');
  const outputCanvas = document.getElementById('outputCanvas');
  let isResizing = false;
  let initialX, initialControlsWidth;

  resizeHandle.addEventListener('mousedown', (e) => {
    isResizing = true;
    initialX = e.clientX;
    initialControlsWidth = controlsContainer.offsetWidth;
  });

  document.addEventListener('mousemove', (e) => {
    if (isResizing) {
      e.preventDefault();
      const deltaX = e.clientX - initialX;
      const newControlsWidth = initialControlsWidth + deltaX;

      const containerWidth = window.innerWidth - 32;
      const minWidth = 200;
      const maxControlsWidth = containerWidth - minWidth - 8;

      controlsContainer.style.width = `${Math.max(minWidth, Math.min(newControlsWidth, maxControlsWidth))}px`;
      preview.style.width = `${containerWidth - controlsContainer.offsetWidth - 8}px`;
    }
  });

  document.addEventListener('mouseup', () => {
    isResizing = false;
  });

  function toggleDarkMode() {
    const isDark = document.body.classList.toggle('dark-mode');
    localStorage.setItem('darkMode', isDark ? 'enabled' : 'disabled');
  }

  if (localStorage.getItem('darkMode') === 'enabled') {
    document.body.classList.add('dark-mode');
  }

  tippy('.control-group[data-tippy-content]', {
    theme: 'light',
    placement: 'top',
    arrow: true,
  });

  overlayTypes.forEach(type => {
    if (type === 'ticker') {
      document.getElementById('tickerTitle').addEventListener('input', () => updateOverlay(type));
      document.getElementById('tickerText').addEventListener('input', () => updateOverlay(type));
      document.getElementById('tickerTitleFontColor').addEventListener('input', () => updateOverlay(type));
      document.getElementById('tickerScrollSpeed').addEventListener('input', () => updateOverlay(type));
      document.getElementById('tickerTitleBlink').addEventListener('change', () => updateOverlay(type));
    } else if (type === 'bible') {
      document.getElementById('bibleReference').addEventListener('input', () => updateOverlay(type));
      document.getElementById('bibleContent').addEventListener('input', () => updateOverlay(type));
      document.getElementById('bibleRefFontSize').addEventListener('input', () => updateOverlay(type));
      document.getElementById('bibleTextFontSize').addEventListener('input', () => updateOverlay(type));
    }
    document.getElementById(`${type}FontColor`)?.addEventListener('input', () => updateOverlay(type));
    document.getElementById(`${type}FontSize`)?.addEventListener('input', () => updateOverlay(type));
    document.getElementById(`${type}BgColor`)?.addEventListener('input', () => updateOverlay(type));
    document.getElementById(`${type}BgTransparent`)?.addEventListener('change', () => updateOverlay(type));
    if (type === 'presenter') {
      document.getElementById(`${type}Title`).addEventListener('input', () => updateOverlay(type));
      document.getElementById(`${type}Text`).addEventListener('input', () => updateOverlay(type));
    }
    if (type === 'image') {
      document.getElementById('imageInput').addEventListener('change', () => updateOverlay(type));
    }
  });

  overlayTypes.forEach(type => resetOverlay(type));

  function makeDraggable(element, type) {
    let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
    let isDragging = false;
    let initialTransform = '';
    let initialLeft = '';
    let initialBottom = '';
    let initialTop = '';
    
    element.addEventListener('mousedown', dragMouseDown);
    
    function dragMouseDown(e) {
      if (e.target === element || element.contains(e.target)) {
        e.preventDefault();
        isDragging = true;
        
        if (type === 'bible' || type === 'lyrics' || type === 'presenter') {
          initialTransform = element.style.transform;
          initialLeft = element.style.left;
          initialBottom = element.style.bottom;
          initialTop = element.style.top;
          
          if (initialLeft.includes('%')) {
            const canvas = document.getElementById('outputCanvas');
            const canvasWidth = canvas.offsetWidth;
            const elementWidth = element.offsetWidth;
            const leftPercentage = parseFloat(initialLeft);
            initialLeft = `${(canvasWidth * leftPercentage / 100) - (elementWidth / 2)}px`;
          }
          
          element.style.transform = 'none';
          element.style.left = initialLeft;
          element.style.bottom = 'auto';
          element.style.top = initialTop || `${element.offsetTop}px`;
        }
        
        pos3 = e.clientX;
        pos4 = e.clientY;
        
        document.addEventListener('mouseup', closeDragElement);
        document.addEventListener('mousemove', elementDrag);
        
        element.classList.add('dragging');
        element.style.pointerEvents = 'none';
      }
    }
    
    function elementDrag(e) {
      if (!isDragging) return;
      
      e.preventDefault();
      
      pos1 = pos3 - e.clientX;
      pos2 = pos4 - e.clientY;
      pos3 = e.clientX;
      pos4 = e.clientY;
      
      const currentTop = element.offsetTop;
      const currentLeft = element.offsetLeft;
      
      const newTop = currentTop - pos2;
      const newLeft = currentLeft - pos1;
      
      const canvas = document.getElementById('outputCanvas');
      const canvasRect = canvas.getBoundingClientRect();
      const elementRect = element.getBoundingClientRect();
      
      const maxTop = canvasRect.height - elementRect.height;
      const maxLeft = canvasRect.width - elementRect.width;
      
      element.style.top = `${Math.max(0, Math.min(newTop, maxTop))}px`;
      element.style.left = `${Math.max(0, Math.min(newLeft, maxLeft))}px`;
    }
    
    function closeDragElement() {
      if (!isDragging) return;
      
      isDragging = false;
      
      document.removeEventListener('mouseup', closeDragElement);
      document.removeEventListener('mousemove', elementDrag);
      
      element.classList.remove('dragging');
      element.style.pointerEvents = 'auto';
      
      if (type === 'bible' || type === 'lyrics' || type === 'presenter') {
        element.style.transform = 'none';
        element.style.bottom = 'auto';
      }
    }
  }

  // Initialize with a default song
  songs.push({
    title: 'Amazing Grace',
    segments: [
      { type: 'Verse', content: 'Amazing Grace, how sweet the sound...' },
      { type: 'Chorus', content: 'Grace, grace, God\'s grace...' }
    ],
    activeSegmentIndex: 0
  });
  currentSongIndex = 0;
  updateSongDropdown();
  selectSong('Amazing Grace');
</script>
  </script>
</body>
</html>