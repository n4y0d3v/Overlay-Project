<!DOCTYPE html>
<html>
<head>
  <title>Overlay MVP</title>
  <style>
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f4f4f4;
      margin: 0;
      padding: 0;
      color: #333;
      transition: background 0.3s, color 0.3s;
    }
    .container {
      background: #fff;
      width: 100vw;
      height: 100vh;
      box-sizing: border-box;
      position: relative;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transition: background 0.3s;
    }
    .title-bar {
      background: #fff;
      height: 48px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 16px;
      border-bottom: 1px solid #e0e0e0;
      flex-shrink: 0;
      transition: background 0.3s, border-bottom-color 0.3s;
    }
    .title-bar-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .title-bar-center {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      align-items: center;
    }
    .title-bar h1 {
      font-size: 20px;
      font-weight: 600;
      margin: 0;
      color: #1a1a1a;
      transition: color 0.3s;
    }
    .title-bar-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    #darkModeToggle, #copyOverlayUrl {
      background: none;
      border: 1px solid #d0d0d0;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      color: #666;
      display: flex;
      align-items: center;
      gap: 4px;
      transition: background 0.2s, color 0.3s, border-color 0.3s;
    }
    #darkModeToggle:hover, #copyOverlayUrl:hover {
      background: #f0f0f0;
    }
    .content {
      display: flex;
      flex-wrap: nowrap;
      gap: 0;
      flex: 1;
      overflow: hidden;
    }
    h2 { 
      font-size: 16px;
      font-weight: 500;
      margin: 16px 0 8px;
      color: #444;
      grid-column: 1 / -1;
      transition: color 0.3s;
    }
    .overlay-section {
      border-bottom: 1px solid #e0e0e0;
      padding-bottom: 12px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 8px;
      transition: border-bottom-color 0.3s;
    }
    .control-group {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      min-width: 120px;
      margin: 4px 0;
    }
    label { 
      font-size: 12px;
      font-weight: 500;
      margin-bottom: 4px;
      color: #666;
      transition: color 0.3s;
    }
    input[type="text"], input[type="number"], select { 
      width: 100%;
      max-width: 120px;
      padding: 6px 8px;
      font-size: 13px;
      border: 1px solid #d0d0d0;
      border-radius: 4px;
      transition: border-color 0.2s, background 0.3s, color 0.3s;
    }
    input[type="text"]:focus, input[type="number"]:focus, select:focus {
      border-color: #007bff;
      outline: none;
    }
    input[type="color"] { 
      width: 40px;
      height: 28px;
      padding: 0;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    input[type="checkbox"] { 
      margin-top: 4px;
      accent-color: #007bff;
    }
    input[type="file"] { 
      font-size: 12px;
      padding: 4px 0;
    }
    button {
      background: #007bff;
      color: #fff;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    button i {
      font-size: 12px;
    }
    button:hover { 
      background: #0056b3;
    }
    #preview {
      position: relative;
      width: 40%;
      background: #e8ecef;
      overflow: hidden;
      border: 2px dashed #007bff;
      border-radius: 6px;
      flex: 1 1 40%;
      min-width: 200px;
      max-height: calc(100vh - 48px);
      display: flex;
      justify-content: center;
      align-items: center;
      transition: border-color 0.3s, box-shadow 0.3s;
    }
    #preview:after {
      content: "Output Preview";
      position: absolute;
      top: 5px;
      left: 5px;
      font-size: 12px;
      color: #007bff;
      opacity: 0.7;
    }
    #outputCanvas {
      width: 100%;
      aspect-ratio: 16 / 9;
      max-width: 100%;
      max-height: 100%;
      background: #000;
      position: relative;
      border: 2px solid #333;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      overflow: hidden;
    }
    .overlay {
      position: absolute;
      transition: none;
    }
    .live-indicator {
      position: absolute;
      top: 10px;
      left: 10px;
      background: #ff0000;
      color: #fff;
      padding: 5px 10px;
      font-size: 14px;
      font-weight: bold;
      border-radius: 4px;
    }
    #controlsContainer {
      overflow-y: auto;
      padding: 8px;
      width: 60%;
      min-width: 200px;
      background: #fafafa;
      border-right: 1px solid #e0e0e0;
      box-sizing: border-box;
      scrollbar-width: thin;
      scrollbar-color: #bbb #fafafa;
      transition: background 0.3s, border-right-color 0.3s;
    }
    #controlsContainer::-webkit-scrollbar {
      width: 6px;
    }
    #controlsContainer::-webkit-scrollbar-thumb {
      background: #bbb;
      border-radius: 3px;
      transition: background 0.3s;
    }
    #controlsContainer::-webkit-scrollbar-track {
      background: #fafafa;
      transition: background 0.3s;
    }
    #resizeHandle {
      position: relative;
      width: 8px;
      background: #d0d0d0;
      cursor: ew-resize;
      border-radius: 4px;
      z-index: 10;
      transition: background 0.2s;
    }
    #resizeHandle:hover {
      background: #bbb;
    }

    /* Switch Styles */
    .switch {
      position: relative;
      display: inline-block;
      width: 40px;
      height: 20px;
    }
    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 20px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    input:checked + .slider {
      background-color: #28a745;
    }
    input:checked + .slider:before {
      transform: translateX(20px);
    }

    /* Dark Mode via Class */
    body.dark-mode {
      background: #1a1a1a;
      color: #ddd;
    }
    .dark-mode .container, .dark-mode .title-bar {
      background: #252525;
    }
    .dark-mode .title-bar {
      border-bottom-color: #444;
    }
    .dark-mode .title-bar h1 {
      color: #eee;
    }
    .dark-mode #darkModeToggle, .dark-mode #copyOverlayUrl {
      color: #aaa;
      border-color: #444;
    }
    .dark-mode #darkModeToggle:hover, .dark-mode #copyOverlayUrl:hover {
      background: #333;
    }
    .dark-mode h2 {
      color: #bbb;
    }
    .dark-mode label {
      color: #aaa;
    }
    .dark-mode input[type="text"], .dark-mode input[type="number"], .dark-mode select {
      background: #333;
      border-color: #444;
      color: #ddd;
    }
    .dark-mode input[type="text"]:focus, .dark-mode input[type="number"]:focus, .dark-mode select:focus {
      border-color: #1e90ff;
    }
    .dark-mode button {
      background: #1e90ff;
    }
    .dark-mode button:hover {
      background: #1c86ee;
    }
    .dark-mode #preview {
      background: #2c2c2c;
      border-color: #1e90ff;
    }
    .dark-mode #preview:after {
      color: #1e90ff;
    }
    .dark-mode #controlsContainer {
      background: #2a2a2a;
      border-right-color: #444;
      scrollbar-color: #666 #2a2a2a;
    }
    .dark-mode #controlsContainer::-webkit-scrollbar-thumb {
      background: #666;
    }
    .dark-mode #controlsContainer::-webkit-scrollbar-track {
      background: #2a2a2a;
    }
    .dark-mode #resizeHandle {
      background: #555;
    }
    .dark-mode #resizeHandle:hover {
      background: #777;
    }
    .dark-mode .overlay-section {
      border-bottom-color: #444;
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <script src="https://unpkg.com/tippy.js@6/dist/tippy-bundle.umd.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/themes/light.css" />
</head>
<body>
  <div class="container">
    <div class="title-bar">
      <div class="title-bar-left">
        <h2>Create Your Overlay</h2>
      </div>
      <div class="title-bar-center">
        <label class="switch">
          <input type="checkbox" id="mainToggleOverlays" onchange="toggleAllOverlays()">
          <span class="slider"></span>
        </label>
      </div>
      <div class="title-bar-actions">
        <button id="copyOverlayUrl" title="Copy Overlay URL" onclick="copyOverlayUrl()">
          <i class="fas fa-copy"></i> Copy URL
        </button>
        <button id="darkModeToggle" onclick="toggleDarkMode()">
          <i class="fas fa-adjust"></i> Toggle Dark Mode
        </button>
      </div>
    </div>
    <div class="content">
      <div id="controlsContainer">
        <!-- Bible Lower-Third -->
        <div class="overlay-section">
          <h2>Bible Lower-Third</h2>
          <div class="control-group" data-tippy-content="Enter a Bible verse reference (e.g., John 3:16)">
            <label for="bibleText">Verse Reference</label>
            <input type="text" id="bibleText" placeholder="e.g., John 3:16" value="John 3:16" maxlength="50">
          </div>
          <div class="control-group" data-tippy-content="Select text color">
            <label for="bibleFontColor">Font Color</label>
            <input type="color" id="bibleFontColor" value="#ffffff">
          </div>
          <div class="control-group" data-tippy-content="Set font size in pixels (10-50)">
            <label for="bibleFontSize">Font Size</label>
            <input type="number" id="bibleFontSize" min="10" max="50" value="24">
          </div>
          <div class="control-group" data-tippy-content="Select background color">
            <label for="bibleBgColor">Bg Color</label>
            <input type="color" id="bibleBgColor" value="#333333">
          </div>
          <div class="control-group" data-tippy-content="Make background transparent">
            <label for="bibleBgTransparent">Transparent</label>
            <input type="checkbox" id="bibleBgTransparent">
          </div>
          <div class="control-group">
            <label class="switch">
              <input type="checkbox" id="toggleBible" onchange="toggleOverlay('bible')">
              <span class="slider"></span>
            </label>
          </div>
          <div class="control-group">
            <button onclick="resetOverlay('bible')"><i class="fas fa-undo"></i> Reset</button>
          </div>
        </div>

        <!-- Lyrics Lower-Third -->
        <div class="overlay-section">
          <h2>Lyrics Lower-Third</h2>
          <div class="control-group" data-tippy-content="Enter lyrics text">
            <label for="lyricsText">Lyrics</label>
            <input type="text" id="lyricsText" placeholder="e.g., Amazing Grace..." value="Amazing Grace..." maxlength="50">
          </div>
          <div class="control-group" data-tippy-content="Select text color">
            <label for="lyricsFontColor">Font Color</label>
            <input type="color" id="lyricsFontColor" value="#ffffff">
          </div>
          <div class="control-group" data-tippy-content="Set font size in pixels (10-50)">
            <label for="lyricsFontSize">Font Size</label>
            <input type="number" id="lyricsFontSize" min="10" max="50" value="24">
          </div>
          <div class="control-group" data-tippy-content="Select background color">
            <label for="lyricsBgColor">Bg Color</label>
            <input type="color" id="lyricsBgColor" value="#333333">
          </div>
          <div class="control-group" data-tippy-content="Make background transparent">
            <label for="lyricsBgTransparent">Transparent</label>
            <input type="checkbox" id="lyricsBgTransparent">
          </div>
          <div class="control-group">
            <label class="switch">
              <input type="checkbox" id="toggleLyrics" onchange="toggleOverlay('lyrics')">
              <span class="slider"></span>
            </label>
          </div>
          <div class="control-group">
            <button onclick="resetOverlay('lyrics')"><i class="fas fa-undo"></i> Reset</button>
          </div>
        </div>

        <!-- Presenter Lower-Third -->
        <div class="overlay-section">
          <h2>Presenter Lower-Third</h2>
          <div class="control-group" data-tippy-content="Enter presenter title">
            <label for="presenterTitle">Title</label>
            <input type="text" id="presenterTitle" placeholder="e.g., Pastor" value="Pastor" maxlength="50">
          </div>
          <div class="control-group" data-tippy-content="Enter presenter name">
            <label for="presenterText">Name</label>
            <input type="text" id="presenterText" placeholder="e.g., John Doe" value="John Doe" maxlength="50">
          </div>
          <div class="control-group" data-tippy-content="Select text color">
            <label for="presenterFontColor">Font Color</label>
            <input type="color" id="presenterFontColor" value="#ffffff">
          </div>
          <div class="control-group" data-tippy-content="Set font size in pixels (10-50)">
            <label for="presenterFontSize">Font Size</label>
            <input type="number" id="presenterFontSize" min="10" max="50" value="24">
          </div>
          <div class="control-group" data-tippy-content="Select background color">
            <label for="presenterBgColor">Bg Color</label>
            <input type="color" id="presenterBgColor" value="#333333">
          </div>
          <div class="control-group" data-tippy-content="Make background transparent">
            <label for="presenterBgTransparent">Transparent</label>
            <input type="checkbox" id="presenterBgTransparent">
          </div>
          <div class="control-group">
            <label class="switch">
              <input type="checkbox" id="togglePresenter" onchange="toggleOverlay('presenter')">
              <span class="slider"></span>
            </label>
          </div>
          <div class="control-group">
            <button onclick="resetOverlay('presenter')"><i class="fas fa-undo"></i> Reset</button>
          </div>
        </div>

        <!-- Ticker -->
        <div class="overlay-section">
          <h2>Ticker</h2>
          <div class="control-group" data-tippy-content="Enter ticker title">
            <label for="tickerTitle">Title</label>
            <input type="text" id="tickerTitle" placeholder="e.g., News" value="News" maxlength="50">
          </div>
          <div class="control-group" data-tippy-content="Enter ticker content">
            <label for="tickerText">Content</label>
            <input type="text" id="tickerText" placeholder="e.g., Breaking News" value="Breaking News" maxlength="950">
          </div>
          <div class="control-group" data-tippy-content="Select title text color">
            <label for="tickerTitleFontColor">Title Font Color</label>
            <input type="color" id="tickerTitleFontColor" value="#000000">
          </div>
          <div class="control-group" data-tippy-content="Select content text color">
            <label for="tickerFontColor">Content Font Color</label>
            <input type="color" id="tickerFontColor" value="#ffffff">
          </div>
          <div class="control-group" data-tippy-content="Set font size in pixels (10-50)">
            <label for="tickerFontSize">Font Size</label>
            <input type="number" id="tickerFontSize" min="10" max="50" value="14">
          </div>
          <div class="control-group" data-tippy-content="Select content background color">
            <label for="tickerBgColor">Content Bg Color</label>
            <input type="color" id="tickerBgColor" value="#ff0000">
          </div>
          <div class="control-group" data-tippy-content="Make content background transparent">
            <label for="tickerBgTransparent">Transparent</label>
            <input type="checkbox" id="tickerBgTransparent">
          </div>
          <div class="control-group" data-tippy-content="Set content scroll speed in pixels per second (10-100)">
            <label for="tickerScrollSpeed">Scroll Speed (px/s)</label>
            <input type="number" id="tickerScrollSpeed" min="10" max="100" value="50">
          </div>
          <div class="control-group" data-tippy-content="Toggle title blink animation">
            <label for="tickerTitleBlink">Blink Title</label>
            <input type="checkbox" id="tickerTitleBlink">
          </div>
          <div class="control-group">
            <label class="switch">
              <input type="checkbox" id="toggleTicker" onchange="toggleOverlay('ticker')">
              <span class="slider"></span>
            </label>
          </div>
          <div class="control-group">
            <button onclick="resetOverlay('ticker')"><i class="fas fa-undo"></i> Reset</button>
          </div>
        </div>

        <!-- Image Upload -->
        <div class="overlay-section">
          <h2>Image Upload</h2>
          <div class="control-group" data-tippy-content="Upload a PNG image">
            <label for="imageInput">Upload PNG</label>
            <input type="file" id="imageInput" accept=".png">
          </div>
          <div class="control-group">
            <label class="switch">
              <input type="checkbox" id="toggleImage" onchange="toggleOverlay('image')">
              <span class="slider"></span>
            </label>
          </div>
          <div class="control-group">
            <button onclick="resetOverlay('image')"><i class="fas fa-undo"></i> Reset</button>
          </div>
        </div>
      </div>
      <div id="resizeHandle"></div>
      <div id="preview">
        <div id="outputCanvas">
          <div class="live-indicator">LIVE</div>
        </div>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let overlayId = null;
    const API_KEY = 'YOUR_API_KEY'; // Replace with your API.Bible key
    const BIBLE_ID = 'de4e12af7f28f599-01'; // KJV
    const overlayTypes = ['bible', 'lyrics', 'presenter', 'ticker', 'image'];
    const overlayStates = {
      bible: false,
      lyrics: false,
      presenter: false,
      ticker: false,
      image: false
    };
    const overlayElements = {};

    const bookMap = {
      'genesis': 'GEN', 'gen': 'GEN',
      'exodus': 'EXO', 'exo': 'EXO',
      'john': 'JHN', 'jn': 'JHN',
      'matthew': 'MAT', 'matt': 'MAT',
      'mark': 'MRK', 'mk': 'MRK',
      'luke': 'LUK', 'lk': 'LUK',
    };

    async function fetchBibleText(input) {
      try {
        const cleanedInput = input.replace(/\s+/g, ' ').trim().toLowerCase();
        const rangeMatch = cleanedInput.match(/([a-zA-Z\s]+)\s*(\d+:\d+)(?:\s*[-–]\s*(\d+:\d+))?/);
        const singleMatch = cleanedInput.match(/([a-zA-Z\s]+)\s*(\d+:\d+)/);

        if (!singleMatch) {
          return { text: input, ref: input };
        }

        let book = singleMatch[1].trim();
        let startVerse = singleMatch[2];
        let endVerse = rangeMatch && rangeMatch[3] ? rangeMatch[3] : null;

        book = bookMap[book] || bookMap[book.replace(/\s/g, '')] || 'JHN';
        const startRef = `${book}.${startVerse}`;
        const apiRef = endVerse ? `${startRef}-${book}.${endVerse}` : startRef;

        const response = await fetch(`https://api.scripture.api.bible/v1/bibles/${BIBLE_ID}/passages/${apiRef}?content-type=text`, {
          headers: { 'api-key': API_KEY }
        });

        if (!response.ok) throw new Error(`API error: ${response.status}`);
        const data = await response.json();
        const text = data.data.content.replace(/\n/g, ' ').trim();
        const ref = data.data.reference;
        return { text, ref };
      } catch (error) {
        console.error('Error fetching Bible text:', error);
        return { text: `Error: Invalid reference (${input})`, ref: input };
      }
    }

    function updateOverlay(type) {
      overlayId = overlayId || Math.random().toString(36).substring(2, 7);
      const data = { id: overlayId, type };

      if (type === 'image') {
        const file = document.getElementById('imageInput').files[0];
        if (file && file.type === 'image/png') {
          const reader = new FileReader();
          reader.onload = () => {
            data.image = reader.result;
            socket.emit('customize', data);
            if (overlayStates[type]) renderOverlay(data);
          };
          reader.readAsDataURL(file);
        }
      } else {
        data.fontColor = document.getElementById(`${type}FontColor`).value;
        data.fontSize = document.getElementById(`${type}FontSize`).value + 'px';
        data.bgColor = document.getElementById(`${type}BgTransparent`).checked ? 'transparent' : document.getElementById(`${type}BgColor`).value;
        if (type === 'presenter') {
          data.title = document.getElementById('presenterTitle').value;
          data.text = document.getElementById('presenterText').value;
          socket.emit('customize', data);
          if (overlayStates[type]) renderOverlay(data);
        } else if (type === 'bible') {
          const reference = document.getElementById('bibleText').value;
          fetchBibleText(reference).then(bibleData => {
            data.text = bibleData.text;
            data.ref = bibleData.ref;
            socket.emit('customize', data);
            if (overlayStates[type]) renderOverlay(data);
          });
        } else if (type === 'ticker') {
          data.title = document.getElementById('tickerTitle').value;
          data.text = document.getElementById('tickerText').value;
          data.titleFontColor = document.getElementById('tickerTitleFontColor').value;
          data.titleBlink = document.getElementById('tickerTitleBlink').checked;
          data.scrollSpeed = parseInt(document.getElementById('tickerScrollSpeed').value, 10);
          const totalLength = data.title.length + data.text.length;
          if (totalLength > 1000) {
            data.text = data.text.substring(0, 1000 - data.title.length);
          }
          socket.emit('customize', data);
          if (overlayStates[type]) renderOverlay(data);
        } else {
          data.text = document.getElementById(`${type}Text`).value;
          socket.emit('customize', data);
          if (overlayStates[type]) renderOverlay(data);
        }
      }
    }

    function renderOverlay(data) {
      const outputCanvas = document.getElementById('outputCanvas');
      let overlay = overlayElements[data.type];
      if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = `overlay-${data.type}`;
        overlay.className = 'overlay';
        overlayElements[data.type] = overlay;
        outputCanvas.appendChild(overlay);
      }

      if (data.type === 'ticker') {
        overlay.style.bottom = '5px';
        overlay.style.left = '0';
        overlay.style.width = '100%';
        // Dynamic height based on font size (fontSize in pixels + padding)
        const fontSizePx = parseInt(data.fontSize, 10);
        const tickerHeight = fontSizePx + 8; // Add 8px for padding (2px top + 2px bottom + extra buffer)
        overlay.style.height = `${tickerHeight}px`;
        overlay.style.overflow = 'hidden';
        overlay.style.display = 'flex';

        // Create a temporary element to measure the content width
        const tempDiv = document.createElement('div');
        tempDiv.style.position = 'absolute';
        tempDiv.style.visibility = 'hidden';
        tempDiv.style.whiteSpace = 'nowrap';
        tempDiv.style.fontSize = data.fontSize;
        tempDiv.textContent = data.text + ' • ';
        document.body.appendChild(tempDiv);
        const textWidth = tempDiv.offsetWidth;
        document.body.removeChild(tempDiv);

        // Calculate the content container width (85% of the ticker)
        const contentContainerWidth = outputCanvas.offsetWidth * 0.85;
        // Calculate the number of repetitions needed to fill at least twice the container width for seamless scrolling
        const minRepetitions = Math.ceil((contentContainerWidth * 2) / textWidth);
        const repeatedText = (data.text + ' • ').repeat(Math.max(minRepetitions, 2));

        // Create a second temporary element to measure the repeated content width
        const tempDivRepeated = document.createElement('div');
        tempDivRepeated.style.position = 'absolute';
        tempDivRepeated.style.visibility = 'hidden';
        tempDivRepeated.style.whiteSpace = 'nowrap';
        tempDivRepeated.style.fontSize = data.fontSize;
        tempDivRepeated.textContent = repeatedText;
        document.body.appendChild(tempDivRepeated);
        const repeatedTextWidth = tempDivRepeated.offsetWidth;
        document.body.removeChild(tempDivRepeated);

        // Calculate animation duration based on scroll speed (pixels per second)
        const scrollSpeedPxPerSec = data.scrollSpeed; // pixels per second
        const animationDuration = repeatedTextWidth / scrollSpeedPxPerSec; // seconds

        overlay.innerHTML = `
          <div style="width: 15%; height: 100%; background: #ffffff; font-size: ${data.fontSize}; padding: 2px 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
            <span style="color: ${data.titleFontColor}; ${data.titleBlink ? 'animation: blink 1s step-end infinite;' : ''}">
              ${data.title}
            </span>
          </div>
          <div style="width: 85%; height: 100%; background: ${data.bgColor}; position: relative; overflow: hidden;">
            <div id="tickerContent-${data.id}" style="color: ${data.fontColor}; font-size: ${data.fontSize}; white-space: nowrap; animation: scroll ${animationDuration}s linear infinite; padding: 2px 10px; display: inline-block; position: absolute; top: 0; left: 0;">
              ${repeatedText}
            </div>
          </div>
        `;
        overlay.innerHTML += `
          <style>
            @keyframes scroll {
              0% { transform: translateX(0); }
              100% { transform: translateX(-${repeatedTextWidth}px); }
            }
            @keyframes blink {
              50% { opacity: 0; }
            }
          </style>
        `;
      } else if (data.type === 'bible' || data.type === 'lyrics' || data.type === 'presenter') {
        overlay.style.bottom = '80px';
        overlay.style.left = '20px';
        if (data.type === 'bible') {
          overlay.style.width = '800px';
          overlay.style.height = '200px';
          overlay.innerHTML = `<div style="color: ${data.fontColor}; font-size: ${data.fontSize}; background: ${data.bgColor}; padding: 20px">${data.text}<br><small>${data.ref}</small></div>`;
        } else if (data.type === 'lyrics') {
          overlay.style.width = '600px';
          overlay.style.height = '200px';
          overlay.innerHTML = `<div style="color: ${data.fontColor}; font-size: ${data.fontSize}; background: ${data.bgColor}; padding: 20px">${data.text}</div>`;
        } else if (data.type === 'presenter') {
          overlay.style.width = '300px';
          overlay.innerHTML = `<div style="color: ${data.fontColor}; font-size: ${data.fontSize}; background: ${data.bgColor}; padding: 5px 10px">${data.title}</div><div style="color: ${data.fontColor}; font-size: ${data.fontSize}; background: ${data.bgColor}; padding: 10px">${data.text}</div>`;
        }
      } else if (data.type === 'image') {
        overlay.style.left = '20px';
        overlay.style.top = '20px';
        overlay.innerHTML = `<img src="${data.image}" style="width: 200px; height: 200px;">`;
      }
    }

    function toggleOverlay(type) {
      const toggleSwitch = document.getElementById(`toggle${type.charAt(0).toUpperCase() + type.slice(1)}`);
      overlayStates[type] = toggleSwitch.checked;
      if (overlayStates[type]) {
        updateOverlay(type);
      } else {
        const overlay = overlayElements[type];
        if (overlay) {
          overlay.remove();
          delete overlayElements[type];
        }
      }
      updateMainToggleState();
    }

    function toggleAllOverlays() {
      const allVisible = Object.values(overlayStates).every(state => state);
      overlayTypes.forEach(type => {
        overlayStates[type] = !allVisible;
        const toggleSwitch = document.getElementById(`toggle${type.charAt(0).toUpperCase() + type.slice(1)}`);
        toggleSwitch.checked = overlayStates[type];
        if (overlayStates[type]) {
          updateOverlay(type);
        } else {
          const overlay = overlayElements[type];
          if (overlay) {
            overlay.remove();
            delete overlayElements[type];
          }
        }
      });
      updateMainToggleState();
    }

    function updateMainToggleState() {
      const allVisible = Object.values(overlayStates).every(state => state);
      const mainToggleSwitch = document.getElementById('mainToggleOverlays');
      mainToggleSwitch.checked = allVisible;
    }

    function copyOverlayUrl() {
      if (!overlayId) return;
      const url = `${window.location.origin}/overlay/${overlayId}`;
      navigator.clipboard.writeText(url).then(() => {
        alert('Overlay URL copied to clipboard!');
      }).catch(err => {
        console.error('Failed to copy URL:', err);
      });
    }

    function resetOverlay(type) {
      if (type === 'bible') {
        document.getElementById('bibleText').value = 'John 3:16';
        document.getElementById('bibleFontColor').value = '#ffffff';
        document.getElementById('bibleFontSize').value = '24';
        document.getElementById('bibleBgColor').value = '#333333';
        document.getElementById('bibleBgTransparent').checked = false;
      } else if (type === 'lyrics') {
        document.getElementById('lyricsText').value = 'Amazing Grace...';
        document.getElementById('lyricsFontColor').value = '#ffffff';
        document.getElementById('lyricsFontSize').value = '24';
        document.getElementById('bibleBgColor').value = '#333333';
        document.getElementById('lyricsBgTransparent').checked = false;
      } else if (type === 'presenter') {
        document.getElementById('presenterTitle').value = 'Pastor';
        document.getElementById('presenterText').value = 'John Doe';
        document.getElementById('presenterFontColor').value = '#ffffff';
        document.getElementById('presenterFontSize').value = '24';
        document.getElementById('presenterBgColor').value = '#333333';
        document.getElementById('presenterBgTransparent').checked = false;
      } else if (type === 'ticker') {
        document.getElementById('tickerTitle').value = 'News';
        document.getElementById('tickerText').value = 'Breaking News';
        document.getElementById('tickerTitleFontColor').value = '#000000';
        document.getElementById('tickerFontColor').value = '#ffffff';
        document.getElementById('tickerFontSize').value = '14';
        document.getElementById('tickerBgColor').value = '#ff0000';
        document.getElementById('tickerBgTransparent').checked = false;
        document.getElementById('tickerScrollSpeed').value = '50';
        document.getElementById('tickerTitleBlink').checked = false;
      } else if (type === 'image') {
        document.getElementById('imageInput').value = '';
      }
      if (overlayStates[type]) updateOverlay(type);
    }

    // Drag-to-resize controls and preview horizontally
    const resizeHandle = document.getElementById('resizeHandle');
    const controlsContainer = document.getElementById('controlsContainer');
    const preview = document.getElementById('preview');
    const outputCanvas = document.getElementById('outputCanvas');
    let isResizing = false;
    let initialX, initialControlsWidth;

    resizeHandle.addEventListener('mousedown', (e) => {
      isResizing = true;
      initialX = e.clientX;
      initialControlsWidth = controlsContainer.offsetWidth;
    });

    document.addEventListener('mousemove', (e) => {
      if (isResizing) {
        e.preventDefault();
        const deltaX = e.clientX - initialX;
        const newControlsWidth = initialControlsWidth + deltaX;

        const containerWidth = window.innerWidth - 32;
        const minWidth = 200;
        const maxControlsWidth = containerWidth - minWidth - 8;

        controlsContainer.style.width = `${Math.max(minWidth, Math.min(newControlsWidth, maxControlsWidth))}px`;
        preview.style.width = `${containerWidth - controlsContainer.offsetWidth - 8}px`;
      }
    });

    document.addEventListener('mouseup', () => {
      isResizing = false;
    });

    function toggleDarkMode() {
      const isDark = document.body.classList.toggle('dark-mode');
      localStorage.setItem('darkMode', isDark ? 'enabled' : 'disabled');
    }

    if (localStorage.getItem('darkMode') === 'enabled') {
      document.body.classList.add('dark-mode');
    }

    tippy('.control-group[data-tippy-content]', {
      theme: 'light',
      placement: 'top',
      arrow: true,
    });

    overlayTypes.forEach(type => {
      if (type === 'ticker') {
        document.getElementById('tickerTitle').addEventListener('input', () => updateOverlay(type));
        document.getElementById('tickerText').addEventListener('input', () => updateOverlay(type));
        document.getElementById('tickerTitleFontColor').addEventListener('input', () => updateOverlay(type));
        document.getElementById('tickerScrollSpeed').addEventListener('input', () => updateOverlay(type));
        document.getElementById('tickerTitleBlink').addEventListener('change', () => updateOverlay(type));
      } else {
        document.getElementById(`${type}Text`)?.addEventListener('input', () => updateOverlay(type));
      }
      document.getElementById(`${type}FontColor`)?.addEventListener('input', () => updateOverlay(type));
      document.getElementById(`${type}FontSize`)?.addEventListener('input', () => updateOverlay(type));
      document.getElementById(`${type}BgColor`)?.addEventListener('input', () => updateOverlay(type));
      document.getElementById(`${type}BgTransparent`)?.addEventListener('change', () => updateOverlay(type));
      if (type === 'presenter') {
        document.getElementById('presenterTitle').addEventListener('input', () => updateOverlay(type));
      }
      if (type === 'image') {
        document.getElementById('imageInput').addEventListener('change', () => updateOverlay(type));
      }
    });

    overlayTypes.forEach(type => resetOverlay(type));
  </script>
</body>
</html>